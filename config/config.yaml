pose:
  model_name: "yolo26n-pose.pt" # Pretrained model to start from
  imgsz: 640
  batch: 16
  workers: 8 # DataLoader (CPU/I/O). Teste 8, 12 e 16.
  cache: false # false | ram | disk. "ram" acelera leitura se houver memoria.
  amp: true # mixed precision na GPU (mais rapido e menor uso de VRAM)
  epochs: 200
  patience: 50 # Early stopping epochs
  device: "0" # "cpu" or "0", "1", etc.
  k_folds: 5
  # Estrategias de validacao para treino de pose:
  # - "kfold_misturado":
  #   KFold comum com shuffle. Mistura imagens livremente entre folds.
  #   Mais rapido/simples, mas pode superestimar metricas quando ha imagens muito parecidas
  #   (mesma sessao/camera) em treino e validacao.
  #
  # - "groupkfold_por_sessao":
  #   GroupKFold agrupando por sessao de captura (data + baia/estacao + camera, inferidos do nome do arquivo).
  #   Evita vazamento de contexto entre treino e validacao no mesmo fold.
  #   Recomendado para medir generalizacao real.
  #
  # - "groupkfold_por_anotador":
  #   GroupKFold agrupando por um proxy de "origem/anotador" (prefixo do nome + camera).
  #   Mais restritivo: separa por origem de anotacao para reduzir viÃ©s de anotador/lote.
  #   Pode reduzir metricas de validacao, mas deixa o teste mais robusto.
  #
  # Observacoes:
  # - Se houver poucos grupos para o numero de folds (k_folds), o pipeline faz fallback para kfold_misturado.
  # - O valor e lido como texto; qualquer valor iniciando com "groupkfold" ativa logica de GroupKFold.
  estrategia_validacao: "groupkfold_por_sessao"
  forcar_diversidade_batch: true
  usar_data_augmentation: true
  augmentacao:
    hsv_h: 0.015
    hsv_s: 0.7
    hsv_v: 0.4
    degrees: 5.0
    translate: 0.10
    scale: 0.50
    shear: 2.0
    perspective: 0.0005
    fliplr: 0.0
    flipud: 0.0
    mosaic: 0.7
    mixup: 0.1
    erasing: 0.2

classificacao:
  # Modelos suportados: "xgboost", "catboost", "sklearn_rf"
  modelo_padrao: "sklearn_rf"
  usar_data_augmentation: true # Liga/desliga augmentation para classificacao
  augmentacao_keypoints:
    habilitar: true # Ativa augmentation em keypoints (alem da flag global acima)
    n_copias: 10 # Quantas copias sinteticas gerar por instancia real de treino
    noise_std_xy: 0.004 # Intensidade do ruido gaussiano em XY (escala relativa ao bbox)
    conf_min_keypoint: 0.01 # So aplica ruido em keypoints com confianca >= este valor
    clip_coords: true # Limita coordenadas para dentro da imagem apos ruido
    deterministico: true # Se true, repete exatamente a mesma augmentation entre execucoes
    seed: 42 # Semente do gerador aleatorio quando deterministico=true
  normalizar_orientacao: false   # deve ser true se fliplr > 0
  selecao_instancia:
    conf_min: 0.4
    peso_area: 0.5
    peso_confianca: 0.5
    bonus_centro: 0.2
  filtro_confianca_pose:
    # Filtro de qualidade da pose antes de gerar/classificar features.
    # A confianca usada aqui e a MEDIA DAS CONFIANCAS DOS 8 KEYPOINTS da instancia selecionada.
    # Passos:
    # 1) Filtra keypoints com conf >= conf_min_keypoint_visivel
    # 2) Calcula a media desses keypoints filtrados
    # 3) Compara com conf_media_min; se media < conf_media_min, descarta a instancia
    #
    # Exemplo (8 confs): [0.90, 0.80, 0.70, 0.60, 0.40, 0.20, 0.05, 0.01]
    # - conf_min_keypoint_visivel=0.10 -> entram [0.90, 0.80, 0.70, 0.60, 0.40, 0.20]
    # - media = (0.90+0.80+0.70+0.60+0.40+0.20)/6 = 0.60
    # - se conf_media_min=0.50, aceita; se conf_media_min=0.65, descarta
    habilitar: true # Liga/desliga o filtro de confianca media dos 8 keypoints
    conf_media_min: 0.50 # Limiar minimo da MEDIA (apos filtro) para aceitar a instancia
    conf_min_keypoint_visivel: 0.01 # Limiar minimo por keypoint para ele entrar no calculo da media
  validacao_interna:
    fracao: 0.2
    early_stopping_rounds: 50
    usar_apenas_real: true # Se true, validacao interna usa apenas origem_instancia=real
  # Hiperparametros base do XGBoost (usados diretamente quando otimizacao_hiperparametros.habilitar=false)
  xgboost:
    n_estimators: 1000
    learning_rate: 0.05
    max_depth: 6
    min_child_weight: 1.0
    subsample: 0.8
    colsample_bytree: 0.8
    gamma: 0.0
    reg_alpha: 0.0
    reg_lambda: 1.0
    random_state: 42
    tree_method: "hist"
    device: "cuda" # "cuda" ou "cpu"
    n_jobs: -1
  # Hiperparametros base do CatBoost (usados diretamente quando otimizacao_hiperparametros.habilitar=false)
  catboost:
    iterations: 1000
    learning_rate: 0.05
    depth: 6
    l2_leaf_reg: 3.0
    random_strength: 1.0
    bagging_temperature: 0.5
    rsm: 0.8
    eval_metric: "MultiClass"
    random_seed: 42
    device: "cuda" # "cuda" ou "cpu"
  # Hiperparametros base do RandomForest (usados diretamente quando otimizacao_hiperparametros.habilitar=false)
  rf:
    n_estimators: 400
    max_depth: null
    min_samples_split: 2
    min_samples_leaf: 1
    max_features: "sqrt" # "sqrt", "log2" ou null
    bootstrap: true
    class_weight: null # null ou "balanced"
    random_state: 42
    n_jobs: -1
  # Otimizacao de hiperparametros para XGBoost/CatBoost/RandomForest (menos forca bruta que GridSearch).
  # metodo:
  # - "optuna": TPE/Bayesiano (preferencial, requer optuna instalado)
  # - "random": busca aleatoria simples (fallback)
  otimizacao_hiperparametros:
    habilitar: true
    metodo: "optuna"
    n_trials: 40
    timeout_segundos: null
    seed: 42
  features:
    # Ordem de importancia (gain) do ultimo treino com todas as features.
    # Descomentados ativos; restante comentado para liberar um a um.
    selecionadas:
      - "dist_hip_tail_head" # Distancia quadril-cauda (comprimento posterior)
      - "dist_tail_head_pin_up" # Distancia cauda-pin_up
      - "razao_dist_back_hip_por_dist_hip_hook_up" # Proporcao dorso/quadril para hook_up
      - "bbox_aspect_ratio" # Razao largura/altura do bbox da vaca
      - "pca_excentricidade" # Alongamento global da nuvem de keypoints (PCA)
      - "sc_pin_up_y" # Shape-context Y do pin_up no referencial withers->tail_head
      - "angulo_hook_up_pin_up_tail_head" # Angulo hook_up-pin_up-tail_head
      - "angulo_hook_up_hip_tail_head" # Angulo hook_up-hip-tail_head
      - "sc_hook_up_y" # Shape-context Y do hook_up
      - "razao_dist_hip_hook_up_por_dist_hook_up_pin_up" # Proporcao entre segmentos do quadril superior
      - "angulo_hook_up_back_hook_down" # Angulo hook_up-back-hook_down
      - "sc_back_y" # Shape-context Y do back
      - "angulo_pin_up_hip_pin_down" # Abertura pin_up-hip-pin_down
      - "sc_back_x" # Shape-context X do back
      - "dist_back_hook_up" # Distancia back-hook_up
      - "sc_hip_y" # Shape-context Y do hip
      - "area_poligono_pelvico_norm" # Area pelvica normalizada pelo bbox
      - "sc_hook_down_y" # Shape-context Y do hook_down
      - "sc_hook_up_x" # Shape-context X do hook_up
      - "sc_pin_up_x" # Shape-context X do pin_up
      - "bbox_area_norm" # Area do bbox normalizada pela area da imagem
      - "razao_dist_hip_hook_down_por_dist_hook_down_pin_down" # Proporcao entre segmentos do quadril inferior
      - "razao_dist_hip_tail_head_por_dist_hook_down_pin_down" # Proporcao quadril-cauda vs base inferior
      - "razao_dist_hip_tail_head_por_dist_hook_up_pin_up" # Proporcao quadril-cauda vs base superior
      - "razao_dist_hip_hook_up_por_dist_hip_tail_head" # Proporcao hook_up em relacao ao eixo hip-tail_head
      # - "razao_dist_hip_hook_down_por_dist_hip_tail_head" # Proporcao hook_down em relacao ao eixo hip-tail_head
      # - "razao_dist_back_hip_por_dist_hip_tail_head" # Proporcao tronco traseiro no eixo longitudinal
      # - "razao_dist_back_hip_por_dist_hip_hook_down" # Proporcao back-hip vs hip-hook_down
      # - "razao_dist_back_hip_por_dist_hip_pin_up" # Proporcao back-hip vs hip-pin_up
      # - "razao_dist_back_hip_por_dist_hip_pin_down" # Proporcao back-hip vs hip-pin_down
      # - "razao_largura_hooks_por_largura_pins" # Largura entre hooks dividida pela largura entre pins
      # - "angulo_hook_up_hip_hook_down" # Abertura pelvica no quadril
      # - "angulo_hip_hook_up_pin_up" # Angulo lateral superior da pelve
      # - "angulo_hip_hook_down_pin_down" # Angulo lateral inferior da pelve
      # - "angulo_hook_down_hip_tail_head" # Angulo hook_down-hip-tail_head
      # - "angulo_pin_up_tail_head_pin_down" # Abertura na regiao da cauda entre pins
      # - "angulo_withers_back_tail_head" # Angulo da linha dorsal (withers-back-tail_head)
      # - "area_triangulo_torax_norm" # Area toracica normalizada
      # - "indice_robustez" # Largura de hooks / comprimento withers-tail_head
      # - "indice_triangulo_traseiro" # Area do triangulo hip-pin_up-pin_down normalizada
      # - "desvio_coluna_back_norm" # Desvio perpendicular de back na linha withers-tail_head
      # - "desvio_coluna_hip_norm" # Desvio perpendicular de hip na linha withers-tail_head
      # - "sc_withers_x" # Shape-context X do withers
      # - "sc_withers_y" # Shape-context Y do withers
      # - "sc_hook_down_x" # Shape-context X do hook_down
      # - "sc_hip_x" # Shape-context X do hip
      # - "sc_tail_head_x" # Shape-context X do tail_head
      # - "sc_tail_head_y" # Shape-context Y do tail_head
      # - "sc_pin_down_x" # Shape-context X do pin_down
      # - "sc_pin_down_y" # Shape-context Y do pin_down

paths:
  raw: "dados/raw"
  processed: "dados/processados"
  models: "modelos"
  outputs: "saidas"
